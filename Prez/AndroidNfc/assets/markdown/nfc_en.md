<div class="first-slide"></div>

# **NFC & Android**

## 2013 - I5

### 2013.10.02 Epsi @ **Nantes**


##==##

<div class="title"></div>

# **NFC & Android**

## New Future Communication

### Cours 01 - Présentation Android

![title](/assets/images/Android-Developers.png)

<footer/>


##==##
## Qui suis-je ?

###  Jean-François GARREAU

![avatar center w-300 wp-200](/assets/images/jf.jpg)


![company_logo](/assets/images/sqli_logo.png)
![gdg_logo](/assets/images/GDG-Logo-carre.png)

<footer/>

##==##
<!--
//     _____    ____    __  __   __  __              _____   _____    ______ 
//    / ____|  / __ \  |  \/  | |  \/  |     /\     |_   _| |  __ \  |  ____|
//   | (___   | |  | | | \  / | | \  / |    /  \      | |   | |__) | | |__   
//    \___ \  | |  | | | |\/| | | |\/| |   / /\ \     | |   |  _  /  |  __|  
//    ____) | | |__| | | |  | | | |  | |  / ____ \   _| |_  | | \ \  | |____ 
//   |_____/   \____/  |_|  |_| |_|  |_| /_/    \_\ |_____| |_|  \_\ |______|
//                                                                           
//  
-->


## Sommaire ## 

<div class="no-bullet"></div>

* ![sommaire](/assets/images/android_cupcake.jpg) 
* ![sommaire](/assets/images/android_donut.jpg) Le monde du mobile
* ![sommaire](/assets/images/android_eclair.jpg) Android ? 
* ![sommaire](/assets/images/android_froyo.png) Concepts
* ![sommaire](/assets/images/android_gingerbread.jpg) Développement
* ![sommaire](/assets/images/android_honeycomb.png) Taches Aynscrhones 
* ![sommaire](/assets/images/android_icecreamsandwich.jpg) Base de données
* ![sommaire](/assets/images/android_jellybean.png)

<footer/>

##==##

<!--
  __  __  ____  _   _ _____  ______   __  __  ____  ____ _____ _      ______ 
 |  \/  |/ __ \| \ | |  __ \|  ____| |  \/  |/ __ \|  _ \_   _| |    |  ____|
 | \  / | |  | |  \| | |  | | |__    | \  / | |  | | |_) || | | |    | |__   
 | |\/| | |  | | . ` | |  | |  __|   | |\/| | |  | |  _ < | | | |    |  __|  
 | |  | | |__| | |\  | |__| | |____  | |  | | |__| | |_) || |_| |____| |____ 
 |_|  |_|\____/|_| \_|_____/|______| |_|  |_|\____/|____/_____|______|______|
                                                                             
-->

<div class='transition'></div>

# Le monde du mobile ?

![icon](/assets/images/android_donut.jpg)

##==##


## Le monde du mobile ?

* Nous parlons ici du monde mobile moderne dont l'arrivée a été révolutionnée par l'arrivée de l'Iphone en 2007

<br>
  Le téléphone devient donc un objet du quotidien pour faire tout et n'importe quoi. 


> "Il y a une application pour ça..."



<aside class="notes">

</aside>
<footer/>
##==##

## Le monde du mobile ?


L'usage se révèle cependant fort pratique !

* Utilisation au travail

* Accès à l'information partout n'importe quand 

* Création d'application spécifiques.


<aside class="notes">

</aside>
<footer/>


##==##


## Le monde du mobile ?

### Les acteurs actuels 

![w-200 wp-100](/assets/images/iphone_logo.jpg) 
![w-200 wp-100](/assets/images/android.png) 
![w-200 wp-100](/assets/images/windows-phone-8-logo.jpg)
![w-200 wp-100](/assets/images/blackberry-logo1.jpg) 

![w-200 wp-100](/assets/images/firefox-os.png)
![w-200 wp-100](/assets/images/tizen-logo-white-800.jpg)
![w-200 wp-100](/assets/images/Logo_phonegap.png)
![h-200 wp-100](/assets/images/html5_logo.jpg)

<aside class="notes">

</aside>
<footer/>

##==##

<div class="photo-slide"></div>

![photo-slide](/assets/images/device_fragmentation_bis.jpg);

# Le monde du mobile ?

<footer/>

<aside class="notes">
Qu'est ce qui frappe ? Taille / nombre / puissance
</aside>

##==##

## Le monde du mobile ?

### Considérations importantes ! 

* Les téléphones ont des capacités réduites !

* L'écran d'un téléphone est petit

  Il faut penser à son ergonomie ! Aller à l'essentiel

* On doit optimiser ! 

![center w-300](/assets/images/globe-world-phone-300x300.jpg)


<footer/>

<aside class="notes">
Pas que des S4 sur le marché
</aside>

##==##

## Le monde du mobile ?

### Les pays émergents

![center hp-200](/assets/images/global-mobile-usage-2012.jpg)

![center hp-200](/assets/images/Mobile-growth-rates-20121.png)

<footer/>

<aside class="notes">
Grosse montée des pays émergents ! 
</aside>

##==##

<!--
//               _   _   _____    _____     ____    _____   _____  
//       /\     | \ | | |  __ \  |  __ \   / __ \  |_   _| |  __ \ 
//      /  \    |  \| | | |  | | | |__) | | |  | |   | |   | |  | |
//     / /\ \   | . ` | | |  | | |  _  /  | |  | |   | |   | |  | |
//    / ____ \  | |\  | | |__| | | | \ \  | |__| |  _| |_  | |__| |
//   /_/    \_\ |_| \_| |_____/  |_|  \_\  \____/  |_____| |_____/ 
//                                                                 
//  
-->

<div class='transition'></div>

# Android ?

![icon](/assets/images/android_eclair.jpg)


<aside class="notes">
Modèle choisi

Architecture

Langage

Avantages 

Inconvéninents
</aside>
##==##

## Android

### Modèle Choisi

* OS libre basé sur un noyau linux.

* Android c’est Google mais aussi d’autres boîtes : 

* Open Handset Alliance : 

    * Ensemble de sociétés (84 aujourd’hui) dont l’objectif est de développer des normes ouvertes pour les appareils mobiles

    * Créé en 2007 à l’initiative de google.

<aside class="notes">
Quelques débats existent quand à la main mise sur android par google…
</aside>
<footer/>
##==##


## Android

### Architecture

![center h-600 hp-400](/assets/images/system-architecture.jpg)
<footer/>
##==##

## Android

### Historique des versions

* 2007 : 1.1 → La base
* 05 2009 : 1.5 (Cupcake) → Widgets
* 09 2009 : 1.6 (Donut) → Synthèse vocale
* 10 2009 : 2.0->2.1 (Eclair) → Expérience utilisateur améliorée
* 05 2010 : 2.2 (Froyo) → JIT
* 10 2010 : 2.3 (Gingerbreard) → NFC
* 01 2011 : 3.0->3.2 (HoneyComb) → Android & tablettes
* 11 2011 : 4.0.x (Ice Cream Sandwich) → Unification tablettes et téléphones
* 05/12, 10/12, 07/13 : 4.1.x->4.3.x (Jelly Bean) → La rapidité en vue

<footer/>
##==##

## Android

### Langage

* Java dans une version 1.5 light

* Google a intégré une bonne partie des packages bas niveau Java.

    * Google a fait sa propre JVM =» Dalvik Virtual Machine

    * Tout le code est converti en .dex (dalvik Executable) avant d’être envoyé sur le téléphone.

<aside class="notes">
Il existe aussi la possibilité de coder en php via un framework externe ASE (ajoute un interpreteur)

sinon google autorise avec le NDK du developpement C C++

Il existe aussi la possibilité de coder e,n C# avec mono android (dispo depuis peu pour android 4.0)

Sinon des solutions comme PhoneGap ou HTML5 via une webview !
</aside>
<footer/>
##==##


## Android

### Avantages

* Android est libre et en Java

 La grande majorité des frameworks java proposent des adpations android

* Le monde Java est très riche en tutoriels en tout genre.

* Google travaille activement à enrichir le framework

* La communauté est très active et propose de nombreuses librairies !

<footer/>
##==##

## Android

### Inconvénients



* Le manque de certaines librairies bas niveau

* La fragmentation d’Android

 Par les versions

 Par le parc d’appareils
 
<footer/>
##==##
## Android

### Fragmentation

<div class="hidden-print"></div>
![float-left w-500 wp-200](/assets/images/chart.png)


|Version|Codename|API|Distribution|
|-----|------|-|----------|
|2.2|Froyo|8|2.4%|
|2.3.3 - 2.3.7|Gingerbread|10|30.7%|
|3.2|Honeycomb|13|0.1%|
|4.0.3 - 4.0.4|Ice Cream Sandwich|15|21.7%|
|4.1.x|Jelly Bean|16|36.6%|
|4.2.x||17|8.5%|

<aside class="notes">
Les evolutions d’api ! Car comme le système est neuf, il évolue souvent et donc il faut faire des fois du code spécifique par target.

Concernant openGL on est obligé de faire du spécifique par téléphone. Des frameworks arrivent pour aider AndEngine, PlayN 

Android avait pour vocation de poser des choses communes mais au final on constate que les constructeurs ne jouent pas vraiment le jeu.
</aside>
<footer/>

##==##
<!--
//     _____    ____    _   _    _____   ______   _____    _______    _____ 
//    / ____|  / __ \  | \ | |  / ____| |  ____| |  __ \  |__   __|  / ____|
//   | |      | |  | | |  \| | | |      | |__    | |__) |    | |    | (___  
//   | |      | |  | | | . ` | | |      |  __|   |  ___/     | |     \___ \ 
//   | |____  | |__| | | |\  | | |____  | |____  | |         | |     ____) |
//    \_____|  \____/  |_| \_|  \_____| |______| |_|         |_|    |_____/ 
//                                                                          
//      
-->

<div class='transition'></div>

# Concepts 

![icon](/assets/images/android_froyo.png)


<aside class="notes">
Activity

Fragments

Cycle de vie des activités

Les services

Les Intents

Les contents providers

Broadcast recivers

Le reste
</aside>
##==##

## Concepts

### Activity

<div class="float-left w-800 wp-400"></div>

* Base graphique

* Une application graphique possède au moins une activité

* Une activité est définie par un layout

  Définition xml des éléments graphiques

* Une activité peut posséder des filtres de lancements

![](/assets/images/ui_overview_home_screen.png)

<aside class="notes">
Les filtres servent par exemple à définir quelle sera l'activité principale quand on lance l'application
</aside>
<footer/>
##==##


## Concepts

### Cycle de vie des activités

![center h-700 hp-400](/assets/images/activity_lifecycle.png)

<aside class="notes">
Quand un process est trop longtemps mis en tache de fond il peut être killé
</aside>
<footer/>
##==##


## Concepts

### Fragments

* Comme une activité mais en plus basique

* Une activité peut avoir N Fragment

* Un fragment peut être réutilisé

* Un fragment possède son propre cycle de vie

![center h-400 hp-200](/assets/images/fragments.png)

<aside class="notes">
Les fragments sont la base à utiliser quand on envisage un développement
</aside>
<footer/>
##==##


## Concepts

### Cycle de vie des fragments

![center h-700 hp-400](/assets/images/fragment_lifecycle.png)
<footer/>
##==##

## Concepts

### Service

* Sortes de threads

* Sont des tâches démons d'Android !

* Permet de réaliser des tâches asynchornes

* N'a pas besoin de couche graphique

* Les services doivent être bindés pour communiquer avec les activités

<br>

![center w-600 hp-100](assets/images/banner-process.png)

<aside class="notes">
Les services sont très utiles pour gérer tous les traitements un minimum longs

Attention cependant à bien les lancer dans des threads car sinon il bloquent le process qui en est à l'origine.

Donner un exemple de lecteur MP3 Ou alors d'avoir les accès HTTP
</aside>
<footer/>
##==##


## Concepts

### Cycle de vie des services

![center h-700 hp-400](/assets/images/service_lifecycle.png)

<aside class="notes">
Comme vous pouvez le voir, un service à la possibilité de communiquer avec un Binder (souvent son appelant) de cette manière on peut tenir au courant l'ihm des avancées du service.
</aside>
<footer/>
##==##

## Concepts

### Intent

<div class="float-left w-800 wp-400"></div>

* Gestion des messages dans Android

* Ils peuvent transporter des informations

  Par défaut simples

  Mais on peut envoyer des objets complexes


![w-200 wp-200](assets/images/webintent-logo.jpg)


* Plusieurs applications peuvent les réceptionner

* En mode broadcast

* Peuvent être adressés à des activités, services, broadcastReceiver


<aside class="notes">
L'intent est très très important car sans lui les différents processus (activités, services, …) ne pourraient pas communiquer.

Si on veut faire passer des objets complexes, il faut que nos objets implémentent une certaine interface

L'avantage de la multi réception est d'avoir la possibilité de réécrire des briques métiers. On peut ainsi enrichir les fonctionnalités de bases.

Expliquer en quoi c'est puissant les boradcast ! Sms etc ...
</aside>
<footer/>
##==##


## Concepts

### ContentProvider

<div class="float-left w-800 wp-400"></div>

* Sorte de base de données partagées

* On peut définir ses propres contentProvider

* Les données sont structurée en tables

![w-200 wp-200](assets/images/Database_1.png)

* Propose une interface standard permettant de séparer le processus de la base des autres processus

* Est à utiliser si l'on veut partager ses données avec d'autres applications

* Sinon il faut passer par une base SQLITE.

<aside class="notes">
De cette manière on peut accéder facilement aux données du téléphone

On peut aussi offrir la possibilité de toucher aux données de son application.
</aside>
<footer/>
##==##


## Concepts

### BroadCastReceiver

* C'est ce qui permet d'intercepter les messages du téléphone et les intents des autres applications

* Se déclare avec le tag **receiver**

* Par défaut un broadCastReceiver n'est pas appelé dans un ordre précis.



<aside class="notes">
De cette manière on peut agir sur la réception d'un SMS ou d'un appel.

Utiliser android:priority pour forcer un ordre
</aside>
<footer/>
##==##


## Concepts

### Widgets

* Composants graphiques déportés sur la "home" du téléphone

* Peuvent êtreredimensionnable
* Peut contenir des images / des listes / des pages. 

 <br>

 ![center](assets/images/widgets_info.png)

<footer /> 

##==##

## Concepts

### Sécurité

![float-right h-500 hp-400](assets/images/auth.jpg)

Une application n'a accès à des données / sensors du téléphone que si elle en a obtenue l'autorisation ! 

<br>
On doit donc spécifier lors de la conception de son application si l'on souhaite accéder à une fonctionnalité du téléphone ou alors à une api.

Il en est de même pour l'accès à des content providers distant ou des fonctionnalités d'autres applications.


<footer />

##==##

## Concepts

### Quelques autres concepts

* L’internationalisation

* Les Outils

* Natif

* Sensors

* GCM

* Graphique : 

 * Canvas

 * OpenGL ES

 * SurfaceView


<aside class="notes">
Il resterait encore plein de notions à traiter mais parlons rapidement de celles là.

Les widgets sont des éléments graphiques propres à android et disponible uniquement depuis l'application de bureau d'android. Les widgets sont des éléments indépendants ou non de l'application auquel ils appartiennent.

La base de données est SQLLite (connu au niveau HTML5)

L'internationnalisation est très simplifée, il suffit de déclarer un fichier par langue et le framework android s'occupe du reste

Le draw9Patch : très pratique pour les ressources graphiques =» principe de déclarer uniquement les zones extensibles.

Encore bien d'autres choses....
</aside>
<footer/>

##==##


<!--
//    _____    ______  __      __  ______   _         ____    _____    _____    ______   __  __   ______   _   _   _______ 
//   |  __ \  |  ____| \ \    / / |  ____| | |       / __ \  |  __ \  |  __ \  |  ____| |  \/  | |  ____| | \ | | |__   __|
//   | |  | | | |__     \ \  / /  | |__    | |      | |  | | | |__) | | |__) | | |__    | \  / | | |__    |  \| |    | |   
//   | |  | | |  __|     \ \/ /   |  __|   | |      | |  | | |  ___/  |  ___/  |  __|   | |\/| | |  __|   | . ` |    | |   
//   | |__| | | |____     \  /    | |____  | |____  | |__| | | |      | |      | |____  | |  | | | |____  | |\  |    | |   
//   |_____/  |______|     \/     |______| |______|  \____/  |_|      |_|      |______| |_|  |_| |______| |_| \_|    |_|   
//                                                                                                                         
// 
-->

<div class='transition'></div>

# Développement

![icon](/assets/images/android_gingerbread.jpg)
<aside class="notes">
Les composants graphiques
</aside>
##==##


## Développement

### L'environement de développement

2 solutions officellement soutenues par Google : 

<div class="no-bullet"></div>

* ![w-100 wp-100](assets/images/eclipse.png) Eclipse et son plugin ADT

<br>

* ![w-100 wp-100](assets/images/android_studio.png) Android Studio basé sur IntelliJ

<footer />

##==##


## Développement

### Emulateur

![center h-400 hp-300](/assets/images/emulator.png)

* Permet d'émuler efficacement le téléphone
 * GPS
 * Téléphone
 * SMS

* Multi résolution

<aside class="notes">
On peut aussi simuler les perturbation réseaux

On peut faire du debug

O n a accès aux logs de l'application

On peut faire des captures d'écrans

Parler de ce qu'on ne peut pas faire : BluTooth, NFC, Caméra c'est pas évident, ...
</aside>
<footer/>

##==##

## Développement

### Genymotion

Il s'agit d'un autre émulateur basé sur VirtualBox et offrant des performances meilleurs !

![center h-400 hp-300 float-right](assets/images/GenyMotion.png)

On peut facilement simuler : 

* GPS 

* Rotation

* Caméra

<footer />

##==##

## Développement

### Les éléments graphiques

* Les TextView et EditText

![center](/assets/images/textViewAndEditText.png)
<footer/>
##==##

## Développement

### Les éléments graphiques

* Button et ImageButton / CheckBox, RadioButton, Spinner

![float-left](/assets/images/ImageButton.png)

![float-right](/assets/images/ChcRadioSpinner.png)
<footer/>
##==##

## Développement

### Les éléments graphiques

* Gallery, GridView et ListView

![float-left w-300 wp-200](/assets/images/GalleryView.png)

![float-right w-300 wp-200](/assets/images/GridView.png)

![center w-300 wp-200](/assets/images/ListView.png)
<footer/>
##==##

## Développement

### Les éléments graphiques


* TabView

![center](/assets/images/TabView.png)
 

Et bien d'autres ...

<aside class="notes">
Et il en existe encore pleins d'autres … TimePicket, DatePicker ....
</aside>
<footer/>
##==##


## Développement

### Multi Plateformes

* Développer sous android se fait aussi facilement sous linux, windows ou mac.

* Sous windows il suffit d'installer les drivers et le téléphone est reconnu

* Sous Linux il faut modifier un fichier en spécifiant le constructeur

* Sous Mac ça marche direct

<footer/>
##==##


## Développement

### Hello World

![center ](/assets/images/project_1.jpg)

<aside class="notes">
On défini le nom du projet, 

La version android visée

Le fait de choisir google apis, vous permet d'avoir accès aux api google du genre maps.

On doit ensuite choisir un nom de package afin d'intentifier votre application (ils sont unique pour les applis du market)

On définit une Activité par défaut
</aside>
<footer/>


##==##


## Développement

### Le Projet

![float-left h-600 hp-400](/assets/images/project_3.png)

![dev_code](/assets/images//arrow_left.png)

![dev_gen](/assets/images//arrow_left.png)

![dev_res](/assets/images//arrow_split.png)

![dev_manifest](/assets/images//arrow_left.png)

Votre code 
<br><br><br>
Le code auto généré
<br><br><br>
Vos ressources dynamiques
<br><br><br><br>
Le manifest 




<aside class="notes">
Le projet est constitué d'une partie statique (votre code, vos ressources)

Et d'une partie dynamique (la partie gen) contenant toutes les constantes.

La partie res est très importante car elle contient toutes les ressources « dynamiques » extérieurs à votre projet

On peut voir différents répertoire en fonction de la résolution 
</aside>
<footer/>


##==##

## Développement

### Les ressources

* drawable : Tous les xml d'images

* drawable-*dpi : toutes les images (fichiers optimisés pour la densité concernée)

* Layout* : les layouts xml de présentation

* values* : les chaines de caractères, styles, thèmes

* menu : les menus xml


<footer />

##==##

## Développement
### Le layout

Il s'agit d'un fichier xml séparant la couche présentation de la couche de code.

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:orientation="vertical"
    android:layout_width="fill_parent"
    android:layout_height="fill_parent"
    >
    <TextView
        android:layout_width="fill_parent" 
        android:layout_height="wrap_content" 
        android:text="@string/hello"
        />
</LinearLayout>
```

<aside class="notes">
Déclaration d'un sumple texte dans une vue. On remarque que le texte provient d'une ressource

Parler de l'aspect multi résolution

Les xml de définitions peuvent être spécifiques =» un chaque téléphone peut avoir une présentation différente. On peut définir des agencements différents entre les différentes résolutions

On peut aussi affecter des thèmes très simplement à nos applications 
</aside>
<footer/>
##==##
## Développement

### Manifest.xml

Fichier des méta données du projet ! Toutes les autorisations sont précisées ici.

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
      package="com.binomed.sqli"
      android:versionCode="1"
      android:versionName="1.0">
    <application android:icon="@drawable/icon" android:label="@string/app_name">
        <activity android:name=".Convert"
                  android:label="@string/app_name">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>

    </application>
    <uses-sdk android:minSdkVersion="9" />

</manifest> 
```

<aside class="notes">
On retrouve le nom de l'application, l'icone, la déclaration de l'activité principale
</aside>
<footer/>
##==##

<!--
            _______     ___   _  _____ _    _ _____   ____  _   _ ______ 
     /\    / ____\ \   / / \ | |/ ____| |  | |  __ \ / __ \| \ | |  ____|
    /  \  | (___  \ \_/ /|  \| | |    | |__| | |__) | |  | |  \| | |__   
   / /\ \  \___ \  \   / | . ` | |    |  __  |  _  /| |  | | . ` |  __|  
  / ____ \ ____) |  | |  | |\  | |____| |  | | | \ \| |__| | |\  | |____ 
 /_/    \_\_____/   |_|  |_| \_|\_____|_|  |_|_|  \_\\____/|_| \_|______|

-->


<div class='transition'></div>

# Taches Asynchrones

![icon](/assets/images/android_honeycomb.png)


##==##

## Taches Asyncrhones

### ANR

ANR = **Application Not Responding**, Ce message est lancé quand une application ne répond pas et qu'elle est considérée comme bloquée. L'utilisateur sera donc invité à arrêter l'application même si cette dernière avait encore des taches à effecter...

<br>
Elle est déclanchée :

* 5s après qu'une interaction a été demandée et qu'aucune réponse n'a été fournie

* 10s après qu'un broadcastReceiver s'est lancé

<div class="hidden-print"></div>

![center w-400 wp-300](assets/images/anr.png)

<footer />

##==##

## Taches Asynchrones

### Solutions

#### AsyncTasks : 

Thread lancées hors du UI Thread avec un callBack synchronisé sur le UI Thread. Possibilité d'interagir avec le UI Thread.
L'asyncTask est fortement liée à la classe qui l'a lancée et celà peut poser des problèmes.

#### Services : 

Thread lancées hors du UI Thread mais étant détaché de la vie de l'activité appelante ! Il n'est pas syncrhonisé par défaut avec l'activité appelante ce qui complexifie la communication.



<footer />

<aside class="notes">
Loaders ! pour charger depuis la base !
</aside>

##==##

## Taches asyncrhones

### AsynTask

Il s'agit d'une classe 

```java
private class BigCalcul extends AsyncTask<Void, Integer, Void>
{
  protected void onPreExecute() {
    // Interaction avec l'UI pour notifier le début (UI Syncrhone)
  }
  protected void onProgressUpdate(Integer... values){
    // Permet de notifier de l'avancement (UI Synchrone)
  }
  protected Void doInBackground(Void... arg0) {
    // Tache long (UI Asynchrone)
    return null;
  }
  protected void onPostExecute(Void result) {
    // Interaction avec l'UI pour notifier la fin (UI Syncrhone)
  }
}
```
<footer />

##==##

## Taches asyncrhones

### AsynTask

Se lance très facilement

```java
mButton.setOnClickListener(new OnClickListener(){
  
  @Override
  public void onClick(View arg0){
    BigCalcul calcul = new BigCalcul();
    calcul.execute();

  }

});
```
<footer />

##==##

## Taches Asyncrhones

### AsyncTask

#### Avantages : 

* Facile à mettre en oeuvre

* Fait ce qu'on lui demande

<br><br>
#### Inconvénients : 

* Peut être à l'origine de memory leaks !

<footer />


##==## 

## Taches Asyncrhones

### Services


* Comme pour les asyncTask sont des composants permettant le lancement de taches en background.

* Un service n'est pas forcément lancé par une activité ! Il peut être lancé par un broadcast receiver.

* Un service est donc indépendant de toute IHM => une application peut exister à travers simplement un service.

* Il existe 2 classes à hériter : 

 * Service : Le on reste dans le Thread d'appel ! 

 * IntentService : On est dans un Thread séparé et les messages sont traités à la suite les uns des autres.

<footer />

##==##

## Taches Asyncrhones

### Services

![center h-700 hp-400](/assets/images/service_lifecycle.png)

<footer />

##==## 

## Taches Asyncrhones

### Services

La notion de binding sert assurer la communication avec le processus appelant pour passer des objets / informations.

![center h-500 hp-300](/assets/images/service_binding_tree_lifecycle.png)

<footer />

##==## 

## Taches Asyncrhones

### Services 

```java
public class HelloIntentService extends IntentService {

  public HelloIntentService() {
    super("HelloIntentService");
  }

  protected void onHandleIntent(Intent intent) {
    //  Long task
  }
}
```

Chaque Intent est placé dans une Queue qui est passée à onHandleIntent. Un service s'arrête une fois que tous les intents on été traites, on passe alors dans stopSelf();

<footer />

##==## 

## Taches Asyncrhones

### Services 


```java
public class HelloService extends Service {
 
  public void onCreate() {
    // Lancement d'un éventuel Thread avec la tache longue
  }

  public int onStartCommand(Intent intent, int flags, int startId) {
    // Définit la politique de lancement du Service ainsi que le lancement de la tache longue
    return START_STICKY;
  }

  public IBinder onBind(Intent intent) {
    // Bind le service
    return null;
  }
  
  public void onDestroy() {
    // Appelé à la destruction
  }
}
```


<footer />

##==##

## Taches Asyncrhones

### Communication entre processus

Deux possibilités pour faire communiquer un service avec une Activité : 

* **AIDL** pour Android Interface Definition Language

  Il s'agit d'une interface de communication entre un service et une activité. Les objets passant par l'interface devront être Parcelable (sorte de serialisable). On doit aussi déclarer son interface en utilisant l'extension **.aidl**. La classe sera générée par le framework Android

* En utilisant un Messenger

  Il s'agit de passer des objets déjà existants dans le framework et permettant de se syncrhoniser avec le UI Thread : les Handlers ! 

<footer />

<aside class="notes">
Messager : Chaque partie est abonnée à l'autre et utilise des Messages !
</aside>

##==##

<!--
  ____  _____  
 |  _ \|  __ \ 
 | |_) | |  | |
 |  _ <| |  | |
 | |_) | |__| |
 |____/|_____/ 
             
-->

<div class='transition'></div>

# Base de données

![icon](/assets/images/android_icecreamsandwich.jpg)


##==##

## Base de données


Il y a plusieurs possibilités pour stocker des donneés sur Android : 

<div class="hidden-print"></div>
<br><br>

<div class="float-left w-800 wp-500"></div>

* SharedPreferences : ensemble de clés valeurs 

* Internal Storage : Stockage de fichiers dans l'application 

* External Storage : Stockage de fichiers en public sur la carte SD

* SQLite Database : Stockage structué en base de données

* Network connections : Stockage des données sur un serveur distant.

![w-200 wp-100](assets/images/Database_1.png)


<footer />

##==##

## Base de données

### SharedPreferences

Ensemble de clés / valeurs permettant de stockée le plus souvent des informations de type préférences utilisateurs.

```java
public class Calc extends Activity {
    public static final String PREFS_NAME = "MyPrefsFile";

    protected void onCreate(Bundle state){
       super.onCreate(state);
       // Restore preferences
       SharedPreferences settings = getSharedPreferences(PREFS_NAME, 0);
       boolean silent = settings.getBoolean("silentMode", false);
    }

    protected void onStop(){
       super.onStop();
      // We need an Editor object to make preference changes.
      // All objects are from android.context.Context
      SharedPreferences settings = getSharedPreferences(PREFS_NAME, 0);
      SharedPreferences.Editor editor = settings.edit();
      editor.putBoolean("silentMode", mSilentMode);
      // Commit the edits!
      editor.commit();
    }
}
```

<footer />

##==##

## Base de données

### Internal Storage

Permet de stocker dans une partie privée de l'application. 

```java
String FILENAME = "hello_file";
String string = "hello world!";

FileOutputStream fos = openFileOutput(FILENAME, Context.MODE_PRIVATE);
fos.write(string.getBytes());
fos.close();
```

<footer />

##==##

## Base de données

### External Storage

```java
boolean mExternalStorageAvailable = false;
boolean mExternalStorageWriteable = false;
String state = Environment.getExternalStorageState();

if (Environment.MEDIA_MOUNTED.equals(state)) {
    // We can read and write the media
    mExternalStorageAvailable = mExternalStorageWriteable = true;
} else if (Environment.MEDIA_MOUNTED_READ_ONLY.equals(state)) {
    // We can only read the media
    mExternalStorageAvailable = true;
    mExternalStorageWriteable = false;
} else {
    // Something else is wrong. It may be one of many other states, but all we need
    //  to know is we can neither read nor write
    mExternalStorageAvailable = mExternalStorageWriteable = false;
}
```

<footer/>

##==##

## Base de données

### SQLite 

Mise en place d'un schéma classique avec des colonnes

```java
public class DictionaryOpenHelper extends SQLiteOpenHelper {

    private static final int DATABASE_VERSION = 2;
    private static final String DICTIONARY_TABLE_NAME = "dictionary";
    private static final String DICTIONARY_TABLE_CREATE =
                "CREATE TABLE " + DICTIONARY_TABLE_NAME + " (" +
                KEY_WORD + " TEXT, " +
                KEY_DEFINITION + " TEXT);";

    DictionaryOpenHelper(Context context) {
        super(context, DATABASE_NAME, null, DATABASE_VERSION);
    }

    @Override
    public void onCreate(SQLiteDatabase db) {
        db.execSQL(DICTIONARY_TABLE_CREATE);
    }
}
```

<footer />

##==##

## Base de données

### SQLite Helper méthodes spécifiques

On peut gèrer facilement les versions grace à la méthode suivante : 

```java
  public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
    // Faire tout ce qu'on veut pour la migration
  }
```

L'accès se fait comme suit : 

```java
    mDbHelper = new DictionaryOpenHelper(mCtx);
    mDb = mDbHelper.getWritableDatabase();
    mDb.setLockingEnabled(true);
```

<footer />

##==##

## Base de données

### Content Provider

Offre une api plus haut niveau sur l'accès à notre base SQLlite en vue de l'offrir à d'autres applications.

* Un content provider s'accède à partir d'une URL

* On accède à un content provider de puis la méthode getContentProvider()

* On récupère un Cursor quand on requête un ContentProvider. La requête se décompose comme suit : 

 * Uri d'accès au content provider

 * *projection* : Colonnes à récuper

 * *selection* : Critères de sélection (where)

 * *selectionArgs* : Valeurs associés à la sélection

 * *order* : Order de tri par nom des colonnes.

<footer />

##==##

## Base de données

### Content Provider - Requête 


```java
// Arguments
String[] mSelectionArgs = {""};

// Text à chercher
mSearchString = mSearchWord.getText().toString();


mSelectionClause = UserDictionary.Words.WORD + " = ?";
mSelectionArgs[0] = mSearchString;

mCursor = getContentResolver().query(
    UserDictionary.Words.CONTENT_URI,  // The content URI of the words table
    mProjection,                       // The columns to return for each row
    mSelectionClause                   // Either null, or the word the user entered
    mSelectionArgs,                    // Either empty, or the string the user entered
    mSortOrder);                       // The sort order for the returned rows
```

<footer />

##==##

## Base de données

### Content Provider - Insert


```java
// Uri du content provider
Uri mNewUri;

// objet clé valeurs servant à l'insertion
ContentValues mNewValues = new ContentValues();

mNewValues.put(UserDictionary.Words.APP_ID, "example.user");
mNewValues.put(UserDictionary.Words.LOCALE, "en_US");
mNewValues.put(UserDictionary.Words.WORD, "insert");
mNewValues.put(UserDictionary.Words.FREQUENCY, "100");

mNewUri = getContentResolver().insert(
    UserDictionary.Word.CONTENT_URI,   // the user dictionary content URI
    mNewValues                          // the values to insert
);
```

<footer />

##==##

<div class="last-slide"></div>

<div class="topic-title"></div>

# Cours Mobilité - 01 Android

<div class="presenter"></div>

# **Jean-François Garreau**

<div class="gdg-rule"></div>

# GDG Nantes Leader

<div class="work-rule"></div>

# Ingénieur SQLI

<div class="thank-message"></div>

# **Merci**

![avatar](/assets/images/jf.jpg)

<footer/>